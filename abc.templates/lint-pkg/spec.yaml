# Copyright 2025 The Authors (see AUTHORS file)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: 'cli.abcxyz.dev/v1beta3'
kind: 'Template'

desc: 'Generate the lint-pkg.yml file from the lint.yml file.'

inputs:
  - name: 'abc_version'
    desc: 'The abc cli version to use'
    default: '0.10.1'

steps:
  - desc: 'Include required files and directories'
    action: 'include'
    params:
      from: 'destination'
      paths:
        - '.github/workflows/lint.yml'
      as:
        - '.github/workflows/lint-pkg.yml'

  - desc: 'Replace variables'
    action: 'string_replace'
    params:
      paths:
        - '.github/workflows/lint-pkg.yml'
      replacements:
        - to_replace: "!= 'abcxyz/pkg'"
          with: "== 'abcxyz/pkg'"
        - to_replace: "name: 'lint'"
          with: "name: 'lint-pkg'"
        - to_replace: "uses: 'abcxyz/pkg/.github/actions/"
          with: "uses: './.github/actions/"
        - to_replace: "@main'"
          with: "'"
        - to_replace: '# limitations under the License.'
          with: |-
            # limitations under the License.

            ############################################################################################
            # This file is autogenerated. Please do not update.
            # Instead, update the abc.templates/lint-pkg template and rerender with:
            # ```
            # abc upgrade -manifest-filter="template_location == \"abc.templates/lint-pkg\"" -accept-defaults
            # ```
            ############################################################################################

  - desc: 'Append to .github/workflows/lint-pkg.yml'
    action: 'append'
    params:
      paths: ['.github/workflows/lint-pkg.yml']
      skip_ensure_newline: false
      with: |-
        # REMOVE_IMMEDIATELY
          # Job to confirm if the template needs to be re-rendered
          check-template:
            runs-on: 'ubuntu-latest'
            permissions:
              contents: 'read'
            steps:
              - name: 'Checkout'
                uses: 'actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332' # ratchet:actions/checkout@v4
                with:
                  fetch-depth: 1 # shallow clone

              - name: 'Setup abc'
                uses: 'abcxyz/pkg/.github/actions/setup-binary@main' # ratchet:ignore
                with:
                  download_url: 'https://github.com/abcxyz/guardian/releases/download/v{{.abc_version}}/guardian_{{.abc_version}}_linux_amd64.tar.gz'
                  install_path: '${{ "{{" }} runner.temp }}/.guardian'
                  binary_subpath: 'guardian'
                  cache_key: '${{ "{{" }} runner.os }}_${{ "{{" }} runner.arch }}_guardian_{{.abc_version}}'
                  add_to_path: true

              - name: 'Confirm template unchanged'
                shell: 'bash'
                run: |
                  abc templates render --dest=. ./abc.templates/lint-pkg/ -force-overwrite -accept-defaults
                  if [[ `git status --porcelain` ]]; then
                    echo "[ERROR] lint-pkg.yml needs to re-generated. Please rerun: "
                    echo "  abc upgrade -manifest-filter=\"template_location == \\\"abc.templates/lint-pkg\\\"\" -accept-defaults"
                    exit 1
                  fi

  # This is necessary because we cannot get the correct indentation without the
  # offset line in the above step.
  - desc: 'Remove temporary line'
    action: 'string_replace'
    params:
      paths:
        - '.github/workflows/lint-pkg.yml'
      replacements:
        - to_replace: '# REMOVE_IMMEDIATELY'
          with: '\n'
