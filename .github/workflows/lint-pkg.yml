# Copyright 2025 The Authors (see AUTHORS file)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

############################################################################################
# This file is autogenerated. Please do not update.
# Instead, update the abc.templates/lint-pkg template and rerender with:
# ```
# abc upgrade -manifest-filter="template_location == \"abc.templates/lint-pkg\"" -accept-defaults
# ```
############################################################################################

name: 'lint-pkg'

on:
  pull_request:
  merge_group:

concurrency:
  group: '${{ github.workflow }}-${{ github.head_ref || github.ref }}'
  cancel-in-progress: true

jobs:
  init:
    runs-on: 'ubuntu-latest'
    if: |
      github.repository == 'abcxyz/pkg'
    outputs:
      lint-targets: '${{ steps.lint-targets.outputs.lint-targets }}'
    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332' # ratchet:actions/checkout@v4
        with:
          fetch-depth: 1 # shallow checkout
          ref: '${{ github.event.pull_request.head.sha }}'

      - name: 'Load Config'
        uses: './.github/actions/load-lint-config' # ratchet:exclude
        with:
          filepath: 'lint.yml'
          fail_on_missing: false
          vars: '${{ toJson(vars) }}'

      - name: 'Identify Lint Targets'
        id: 'lint-targets'
        env:
          REF: '${{ github.event.pull_request.head.sha }}'
        shell: 'bash'
        run: |-
          declare -a TARGETS=()
          if git ls-tree -r --name-only "$REF" | LC_ALL=C grep --with-filename -E '(go.mod|/.*\.go$)' >/dev/null; then
            if [[ "$GO_LINT_ENABLED" == "true" ]]; then
              TARGETS+=("golang" "golang-modules")
            fi
          fi
          if git ls-tree -r --name-only "$REF" | LC_ALL=C grep --with-filename -E '.*\.(java)$' >/dev/null; then
            if [[ "$JAVA_LINT_ENABLED" == "true" ]]; then
              TARGETS+=("java")
            fi
          fi
          if git ls-tree -r --name-only "$REF" | LC_ALL=C grep --with-filename -E '.*\.(js)$' >/dev/null; then
            if [[ "$JAVASCRIPT_LINT_ENABLED" == "true" ]]; then
              TARGETS+=("javascript")
            fi
          fi
          if git ls-tree -r --name-only "$REF" | LC_ALL=C grep --with-filename -E '.*\.(ts)$' >/dev/null; then
            if [[ "$TYPESCRIPT_LINT_ENABLED" == "true" ]]; then
              TARGETS+=("typescript")
            fi
          fi
          if git ls-tree -r --name-only "$REF" | LC_ALL=C grep --with-filename -E '.*\.(sh)$' >/dev/null; then
            if [[ "$SHELL_LINT_ENABLED" == "true" ]]; then
              TARGETS+=("shell")
            fi
          fi
          if git ls-tree -r --name-only "$REF" | LC_ALL=C grep --with-filename -E '.*\.(tf)$' >/dev/null; then
            if [[ "$TERRAFORM_LINT_ENABLED" == "true" ]]; then
              TARGETS+=("terraform")
            fi
          fi
          if git ls-tree -r --name-only "$REF" | LC_ALL=C grep --with-filename -E '.*\.(yaml|yml)$' >/dev/null; then
            if [[ "$YAML_LINT_ENABLED" == "true" ]]; then
              TARGETS+=("yaml")
            fi
          fi
          LINT_TARGETS="$(jq --compact-output --null-input '$ARGS.positional' --args -- "${TARGETS[@]}")"
          echo "lint-targets -> ${LINT_TARGETS}"
          echo "lint-targets=${LINT_TARGETS}" >> $GITHUB_OUTPUT

  lint:
    runs-on: |-
     ${{ vars.LINT_RUNS_ON || 'ubuntu-latest' }}
    needs:
      - 'init'
    if: |
      needs.init.outputs.lint-targets != '[]' && github.repository == 'abcxyz/pkg'
    permissions:
      contents: 'read'
    strategy:
      fail-fast: false
      max-parallel: 100
      matrix:
        lint-target: '${{ fromJSON(needs.init.outputs.lint-targets) }}'
    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332' # ratchet:actions/checkout@v4
        with:
          fetch-depth: 1 # shallow clone

      - name: 'Load Config'
        uses: './.github/actions/load-lint-config' # ratchet:exclude
        with:
          filepath: 'lint.yml'
          fail_on_missing: false
          vars: '${{ toJson(vars) }}'

      - name: '[GOLANG] Lint Go'
        if: |
          matrix.lint-target == 'golang'
        uses: './.github/actions/lint-go' # ratchet:exclude
        with:
          go_version: '${{ env.GO_LINT_GO_VERSION }}'
          go_version_file: '${{ env.GO_LINT_GO_VERSION_FILE }}'
          golangci_url: '${{ env.GO_LINT_GOLANGCI_URL }}'
          directory: '${{ env.GO_LINT_DIRECTORY }}'
          golangci_lint_version: '${{ env.GO_LINT_GOLANGCI_LINT_VERSION }}'

      - name: '[GOLANG] Lint Go modules'
        if: |
          matrix.lint-target == 'golang-modules'
        uses: './.github/actions/lint-go-modules' # ratchet:exclude
        with:
          go_version: '${{ env.GO_LINT_GO_VERSION }}'
          go_version_file: '${{ env.GO_LINT_GO_VERSION_FILE }}'
          golangci_url: '${{ env.GO_LINT_GOLANGCI_URL }}'
          directory: '${{ env.GO_LINT_DIRECTORY }}'
          golangci_lint_version: '${{ env.GO_LINT_GOLANGCI_LINT_VERSION }}'

      - name: '[JAVA] Lint Java'
        if: |
          matrix.lint-target == 'java'
        uses: './.github/actions/lint-java' # ratchet:exclude
        with:
          java_version: '${{ env.JAVA_LINT_JAVA_VERSION }}'
          java_distribution: '${{ env.JAVA_LINT_JAVA_DISTRIBUTION }}'
          google_java_format_version: '${{ env.JAVA_LINT_GOOGLE_JAVA_FORMAT_VERSION }}'
          directory: '${{ env.JAVA_LINT_DIRECTORY }}'

      - name: '[JAVASCRIPT] Lint Javascript'
        if: |
          matrix.lint-target == 'javascript'
        run: |-
          echo "TODO: Lint javascript"

      - name: '[TYPESCRIPT] Lint Typescript'
        if: |
          matrix.lint-target == 'typescript'
        run: |-
          echo "TODO: Lint typescript"

      - name: '[SHELL] Lint Shell'
        if: |
          matrix.lint-target == 'shell'
        uses: './.github/actions/lint-shell' # ratchet:exclude
        with:
          target: '${{ env.LINT_SHELL_TARGET }}'

      - name: '[TERRAFORM] Lint Terraform'
        if: |
          matrix.lint-target == 'terraform'
        uses: './.github/actions/lint-terraform' # ratchet:exclude
        with:
          terraform_version: '${{ env.TERRAFORM_LINT_TERRAFORM_VERSION }}'
          directory: '${{ env.TERRAFORM_LINT_DIRECTORY }}'
          walk_dirs: '${{ env.TERRAFORM_LINT_WALK_DIRS }}'
          ignored_walk_dirs: '${{ env.TERRAFORM_LINT_IGNORED_WALK_DIRS }}'

      - name: '[YAML] lint yaml'
        if: |
          matrix.lint-target == 'yaml'
        uses: './.github/actions/lint-yaml' # ratchet:exclude
        with:
          yamllint_url: '${{ env.YAML_LINT_YAMLLINT_URL }}'
          yamllint_version: '${{ env.YAML_LINT_YAMLLINT_VERSION }}'
          target: '${{ env.YAML_LINT_TARGET }}'

  # Job to confirm if the template needs to be re-rendered
  check-template:
    runs-on: 'ubuntu-latest'
    permissions:
      contents: 'read'
    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332' # ratchet:actions/checkout@v4
        with:
          fetch-depth: 1 # shallow clone

      - name: 'Setup abc'
        uses: 'abcxyz/pkg/.github/actions/setup-binary@main' # ratchet:ignore
        with:
          download_url: 'https://github.com/abcxyz/abc/releases/download/v0.10.1/abc_0.10.1_linux_amd64.tar.gz'
          install_path: '${{ runner.temp }}/.abc'
          binary_subpath: 'abc'
          cache_key: '${{ runner.os }}_${{ runner.arch }}_abc_0.10.1'
          add_to_path: true

      - name: 'Confirm template unchanged'
        shell: 'bash'
        run: |
          abc templates render --dest=. ./abc.templates/lint-pkg/ -force-overwrite -accept-defaults
          if [[ `git status --porcelain . -- ':!.abc/'` ]]; then
            echo "[ERROR] Changed files:"
            git status --porcelain . -- ':!.abc/'
            echo "[ERROR] lint-pkg.yml needs to re-generated. Please rerun: "
            echo "  abc upgrade -manifest-filter=\"template_location == \\\"abc.templates/lint-pkg\\\"\" -accept-defaults"
            exit 1
          fi
