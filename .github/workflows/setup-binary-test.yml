# Copyright 2023 The Authors (see AUTHORS file)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: 'setup-binary-test'

on:
  pull_request:
    paths:
      - '.github/actions/setup-binary/**'
      - '.github/workflows/setup-binary-test.yml'

jobs:
  setup-binary-test:
    strategy:
      fail-fast: false
      matrix:
        include:
          # checksums generated from sha512sum
          - os: 'ubuntu-latest'
            name: 'linux'
            arch: 'amd64'
            ext: 'tar.gz'
            checksum: '3e7405d3e1b34a97a33a47b22d1a95309c3f889f3f5edcaa72a1d421ea3348e6ba148ccf49e9a3f35d762f5f4f0ebb71e5b270b990486ad78628887034e56a67'
          - os: 'ubuntu-24.04-arm'
            name: 'linux'
            arch: 'arm64'
            ext: 'tar.gz'
            checksum: '7a0d86fd0d1256820088199e637f803aadb74db5500626108da54bff71cd3cd3a0bf6bec8fa4a98dd416f0891cf7e208a60819f95e1246d4b02e210b8fdd9ec5'

          - os: 'windows-latest'
            name: 'windows'
            arch: 'amd64'
            ext: 'zip'
            checksum: 'fa32586defb8dc3149eb665bcf4520ae0a203eb8c75538e516bca6174bb78f8cb2e25436c41c473d67528d24ed363d7e6d7140e840d948a96dc6a0a934120457'
          - os: 'windows-11-arm'
            name: 'windows'
            arch: 'arm64'
            ext: 'zip'
            checksum: '9a173bf6fd9d7fc4d81182c7bf738cec796cb6828f22ed16da088fa6f54e870150e594389bc2c3f9f520c6d28d9bc9502d4585ebd7db64f5b3e591682d1c730a'

          # Macs can run Intel and AMD binaries
          - os: 'macos-latest'
            name: 'darwin'
            arch: 'amd64'
            ext: 'tar.gz'
            checksum: '68e721c78b8a7302e872e5df49784ea4e1fccbeca7d1d6f6ec2df2b4f163f2944da9b253a2d97a80ac7e18742c8667d219b792e50e96197796105a2579687e1d'
          - os: 'macos-latest'
            name: 'darwin'
            arch: 'arm64'
            ext: 'tar.gz'
            checksum: '1bd94ae9b19963dca7e4958017a8ce030388c57505e1ddb48b059cd2389a6c203439852939c12256c3dcd6193411268b2c0cdcc2a8eb40c416584a70f1b4b6a9'
    runs-on: '${{ matrix.os }}'
    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683' # ratchet:actions/checkout@v4

      - name: 'Path'
        id: 'path'
        shell: 'bash'
        run: |
          # A Powershell path export is needed due to Git Bash on Windows not keeping PATH changes persistent.
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            powershell 'echo "path=${HOME}\.ratchet" >> $env:GITHUB_OUTPUT'
          else
            echo "path=${HOME}/.ratchet" >> $GITHUB_OUTPUT
          fi
          echo "install_path: ${HOME}/.ratchet"

      - name: 'Setup binary (save cache)'
        uses: './.github/actions/setup-binary' # ratchet:exclude
        with:
          install_path: '${{ steps.path.outputs.path }}'
          download_url: 'https://github.com/sethvargo/ratchet/releases/download/v0.11.1/ratchet_0.11.1_${{ matrix.name }}_${{ matrix.arch }}.${{ matrix.ext }}'
          checksum: '${{ matrix.checksum }}'
          cache_key: '${{ runner.os }}_${{ matrix.arch }}_ratchet_${{ github.sha }}'
          binary_subpath: 'ratchet'

      - name: 'Setup binary (restore cache)'
        uses: './.github/actions/setup-binary' # ratchet:exclude
        with:
          install_path: '${{ steps.path.outputs.path }}'
          download_url: 'https://github.com/sethvargo/ratchet/releases/download/v0.11.1/ratchet_0.11.1_${{ matrix.name }}_${{ matrix.arch }}.${{ matrix.ext }}'
          checksum: '${{ matrix.checksum }}'
          cache_key: '${{ runner.os }}_${{ matrix.arch }}_ratchet_${{ github.sha }}'
          add_to_path: true
          binary_subpath: 'ratchet'
          destination_subpath: 'renamed_ratchet'

      - name: 'Test'
        shell: 'bash'
        run: |
          renamed_ratchet -version
          GOT=$(renamed_ratchet -version 2>&1) # abcxyz/pkg/cli writes help to stderr
          WANT="ratchet 0.11.1"

          if [[ "${GOT}" != "${WANT}"* ]]; then
            echo "::error ::Expected ${GOT} to contain ${WANT}"
            exit 1
          fi
